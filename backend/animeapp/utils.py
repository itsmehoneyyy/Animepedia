import requests
from django.conf import settings

GENRE_RULES = {
    "แอ็กชัน": ["ต่อสู้", "ลุย", "ศัตรู", "สงคราม", "ฝึก", "พลัง", "ปะทะ", "เอาตัวรอด", "ไล่ล่า"],
    "แฟนตาซี": ["เวทมนตร์", "ปีศาจ", "อสูร", "โลกคู่ขนาน", "พลังลึกลับ", "ดาบ", "คทา", "มิติ", "คำสาป"],
    "โรแมนซ์": ["รัก", "หัวใจ", "ความรู้สึก", "ความผูกพัน", "แฟน", "สารภาพรัก", "หึง", "คู่รัก"],
    "คอเมดี้": ["ตลก", "ฮา", "กวน", "ขำ", "เปิ่น", "วุ่นวาย", "แกล้ง", "ซวย", "มุก", "เด็ก"],
    "โรงเรียน": ["โรงเรียน", "นักเรียน", "ห้องเรียน", "สอบ", "ครู", "ชมรม", "มัธยม"],
    "ดราม่า": ["ครอบครัว", "พี่น้อง", "อดีต", "เสียใจ", "ความสูญเสีย", "น้ำตา", "เติบโต", "ความอบอุ่น", "มิตรภาพ"],
    "กีฬา": ["กีฬา", "แข่งขัน", "ฝึกซ้อม", "ทีม", "ศักดิ์ศรี", "บาส", "เทนนิส", "จักรยาน", "กลยุทธ์"],
    "สืบสวน": ["สืบสวน", "ปริศนา", "เงื่อนงำ", "ตามล่า", "องค์กรลับ", "ความลับ", "ไขคดี"],
    "เหนือธรรมชาติ": ["พลังพิเศษ", "คำสาป", "อสูร", "ผี", "โลกวิญญาณ", "ปีศาจ", "พลังจิต", "สิ่งลี้ลับ"],
    "ชีวิตประจำวัน": ["ชีวิตประจำวัน", "เด็ก", "ดูแล", "บ้าน", "ครอบครัว", "เรียบง่าย", "ความสัมพันธ์เล็กๆ"],
    "ไซไฟ": ["สายลับ", "แฝงตัว", "ภารกิจ", "เทคโนโลยี", "อาวุธลับ", "โลกอนาคต", "ทดลอง", "หุ่นยนต์"],
    "ทำอาหาร": ["ทำอาหาร", "อาหาร", "พ่อครัว", "ร้านอาหาร", "วัตถุดิบ", "จานเด็ด", "มื้อพิเศษ"],
    "ต่างโลก": ["ต่างโลก", "อัญเชิญ", "สกิล", "เน็ตซุปเปอร์", "มอนสเตอร์", "ชีวิตใหม่", "โลกใหม่"],
    "ผจญภัย": ["ผจญภัย", "การเดินทาง", "แผนที่", "สำรวจ", "ทะเล", "ภูเขา", "ออกเรือ", "เป้าหมาย", "โลกกว้าง"],
    "จิตวิทยา": ["จิต", "แรงจูงใจ", "ด้านมืด", "เจ็บปวด", "ตัวตน", "สับสน", "ความทรงจำ", "ความกลัว"],
    "ดิสโทเปีย": ["โลกพัง", "รัฐบาล", "ล่มสลาย", "ระบบเผด็จการ", "ความสิ้นหวัง", "การปฏิวัติ", "มนุษยชาติ", "ล้างโลก"]
}

def tlex_tokenize(text: str) -> list[str]:
    """ตัดคำด้วย TLex+ API"""
    url = "https://api.aiforthai.in.th/tlexplus"
    headers = {"Apikey": settings.TLEXPLUS_API_KEY}
    data = {"text": text}
    res = requests.post(url, data=data, headers=headers)
    if res.status_code == 200:
        return res.json().get("tokens", [])
    return []

def detect_genres_from_text(text: str) -> list[str]:
    """ดึง token แล้วแมปกับกฎ GENRE_RULES"""
    tokens = tlex_tokenize(text)
    detected = set()
    for genre, keywords in GENRE_RULES.items():
        if any(tok in tokens for tok in keywords):
            detected.add(genre)
    return list(detected)
